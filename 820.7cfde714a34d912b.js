(()=>{"use strict";function w(e){return this instanceof w?(this.v=e,this):new w(e)}function J(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,t=e[Symbol.asyncIterator];return t?t.call(e):(e=function z(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(o){n[o]=e[o]&&function(s){return new Promise(function(c,l){!function i(o,s,c,l){Promise.resolve(l).then(function(a){o({value:a,done:c})},s)}(c,l,(s=e[o](s)).done,s.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const X=e=>e&&"number"==typeof e.length&&"function"!=typeof e;function d(e){return"function"==typeof e}const R=function Pt(e){const n=e(r=>{Error.call(r),r.stack=(new Error).stack});return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}(e=>function(n){e(this),this.message=n?`${n.length} errors occurred during unsubscription:\n${n.map((r,i)=>`${i+1}) ${r.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=n});function Z(e,t){if(e){const n=e.indexOf(t);0<=n&&e.splice(n,1)}}class _{constructor(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let t;if(!this.closed){this.closed=!0;const{_parentage:n}=this;if(n)if(this._parentage=null,Array.isArray(n))for(const o of n)o.remove(this);else n.remove(this);const{initialTeardown:r}=this;if(d(r))try{r()}catch(o){t=o instanceof R?o.errors:[o]}const{_finalizers:i}=this;if(i){this._finalizers=null;for(const o of i)try{D(o)}catch(s){t=t??[],s instanceof R?t=[...t,...s.errors]:t.push(s)}}if(t)throw new R(t)}}add(t){var n;if(t&&t!==this)if(this.closed)D(t);else{if(t instanceof _){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(n=this._finalizers)&&void 0!==n?n:[]).push(t)}}_hasParent(t){const{_parentage:n}=this;return n===t||Array.isArray(n)&&n.includes(t)}_addParent(t){const{_parentage:n}=this;this._parentage=Array.isArray(n)?(n.push(t),n):n?[n,t]:t}_removeParent(t){const{_parentage:n}=this;n===t?this._parentage=null:Array.isArray(n)&&Z(n,t)}remove(t){const{_finalizers:n}=this;n&&Z(n,t),t instanceof _&&t._removeParent(this)}}function N(e){return e instanceof _||e&&"closed"in e&&d(e.remove)&&d(e.add)&&d(e.unsubscribe)}function D(e){d(e)?e():e.unsubscribe()}_.EMPTY=(()=>{const e=new _;return e.closed=!0,e})();const v={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},O={setTimeout(e,t,...n){const{delegate:r}=O;return r?.setTimeout?r.setTimeout(e,t,...n):setTimeout(e,t,...n)},clearTimeout(e){const{delegate:t}=O;return(t?.clearTimeout||clearTimeout)(e)},delegate:void 0};function q(e){O.setTimeout(()=>{const{onUnhandledError:t}=v;if(!t)throw e;t(e)})}function tt(){}const Ht=L("C",void 0,void 0);function L(e,t,n){return{kind:e,value:t,error:n}}let x=null;class K extends _{constructor(t){super(),this.isStopped=!1,t?(this.destination=t,N(t)&&t.add(this)):this.destination=Kt}static create(t,n,r){return new Q(t,n,r)}next(t){this.isStopped?U(function At(e){return L("N",e,void 0)}(t),this):this._next(t)}error(t){this.isStopped?U(function Ct(e){return L("E",void 0,e)}(t),this):(this.isStopped=!0,this._error(t))}complete(){this.isStopped?U(Ht,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(t){this.destination.next(t)}_error(t){try{this.destination.error(t)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const zt=Function.prototype.bind;function M(e,t){return zt.call(e,t)}class Rt{constructor(t){this.partialObserver=t}next(t){const{partialObserver:n}=this;if(n.next)try{n.next(t)}catch(r){F(r)}}error(t){const{partialObserver:n}=this;if(n.error)try{n.error(t)}catch(r){F(r)}else F(t)}complete(){const{partialObserver:t}=this;if(t.complete)try{t.complete()}catch(n){F(n)}}}class Q extends K{constructor(t,n,r){let i;if(super(),d(t)||!t)i={next:t??void 0,error:n??void 0,complete:r??void 0};else{let o;this&&v.useDeprecatedNextContext?(o=Object.create(t),o.unsubscribe=()=>this.unsubscribe(),i={next:t.next&&M(t.next,o),error:t.error&&M(t.error,o),complete:t.complete&&M(t.complete,o)}):i=t}this.destination=new Rt(i)}}function F(e){v.useDeprecatedSynchronousErrorHandling?function kt(e){v.useDeprecatedSynchronousErrorHandling&&x&&(x.errorThrown=!0,x.error=e)}(e):q(e)}function U(e,t){const{onStoppedNotification:n}=v;n&&O.setTimeout(()=>n(e,t))}const Kt={closed:!0,next:tt,error:function Lt(e){throw e},complete:tt},W="function"==typeof Symbol&&Symbol.observable||"@@observable";function Mt(e){return e}let S=(()=>{class e{constructor(n){n&&(this._subscribe=n)}lift(n){const r=new e;return r.source=this,r.operator=n,r}subscribe(n,r,i){const o=function Ut(e){return e&&e instanceof K||function Qt(e){return e&&d(e.next)&&d(e.error)&&d(e.complete)}(e)&&N(e)}(n)?n:new Q(n,r,i);return function It(e){if(v.useDeprecatedSynchronousErrorHandling){const t=!x;if(t&&(x={errorThrown:!1,error:null}),e(),t){const{errorThrown:n,error:r}=x;if(x=null,n)throw r}}else e()}(()=>{const{operator:s,source:c}=this;o.add(s?s.call(o,c):c?this._subscribe(o):this._trySubscribe(o))}),o}_trySubscribe(n){try{return this._subscribe(n)}catch(r){n.error(r)}}forEach(n,r){return new(r=nt(r))((i,o)=>{const s=new Q({next:c=>{try{n(c)}catch(l){o(l),s.unsubscribe()}},error:o,complete:i});this.subscribe(s)})}_subscribe(n){var r;return null===(r=this.source)||void 0===r?void 0:r.subscribe(n)}[W](){return this}pipe(...n){return function et(e){return 0===e.length?Mt:1===e.length?e[0]:function(n){return e.reduce((r,i)=>i(r),n)}}(n)(this)}toPromise(n){return new(n=nt(n))((r,i)=>{let o;this.subscribe(s=>o=s,s=>i(s),()=>r(o))})}}return e.create=t=>new e(t),e})();function nt(e){var t;return null!==(t=e??v.Promise)&&void 0!==t?t:Promise}const Gt=function Yt(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function j(e){if(e instanceof S)return e;if(null!=e){if(function Wt(e){return d(e[W])}(e))return function Zt(e){return new S(t=>{const n=e[W]();if(d(n.subscribe))return n.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(e);if(X(e))return function Nt(e){return new S(t=>{for(let n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()})}(e);if(function jt(e){return d(e?.then)}(e))return function Dt(e){return new S(t=>{e.then(n=>{t.closed||(t.next(n),t.complete())},n=>t.error(n)).then(null,q)})}(e);if(function $t(e){return Symbol.asyncIterator&&d(e?.[Symbol.asyncIterator])}(e))return rt(e);if(function Vt(e){return d(e?.[Gt])}(e))return function qt(e){return new S(t=>{for(const n of e)if(t.next(n),t.closed)return;t.complete()})}(e);if(function Xt(e){return d(e?.getReader)}(e))return function te(e){return rt(function Jt(e){return function V(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,r=n.apply(e,t||[]),o=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(h){r[h]&&(i[h]=function(p){return new Promise(function(m,y){o.push([h,p,m,y])>1||c(h,p)})})}function c(h,p){try{!function l(h){h.value instanceof w?Promise.resolve(h.value.v).then(a,u):f(o[0][2],h)}(r[h](p))}catch(m){f(o[0][3],m)}}function a(h){c("next",h)}function u(h){c("throw",h)}function f(h,p){h(p),o.shift(),o.length&&c(o[0][0],o[0][1])}}(this,arguments,function*(){const n=e.getReader();try{for(;;){const{value:r,done:i}=yield w(n.read());if(i)return yield w(void 0);yield yield w(r)}}finally{n.releaseLock()}})}(e))}(e)}throw function Bt(e){return new TypeError(`You provided ${null!==e&&"object"==typeof e?"an invalid object":`'${e}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}(e)}function rt(e){return new S(t=>{(function ee(e,t){var n,r,i,o;return function Y(e,t,n,r){return new(n||(n=Promise))(function(o,s){function c(u){try{a(r.next(u))}catch(f){s(f)}}function l(u){try{a(r.throw(u))}catch(f){s(f)}}function a(u){u.done?o(u.value):function i(o){return o instanceof n?o:new n(function(s){s(o)})}(u.value).then(c,l)}a((r=r.apply(e,t||[])).next())})}(this,void 0,void 0,function*(){try{for(n=J(e);!(r=yield n.next()).done;)if(t.next(r.value),t.closed)return}catch(s){i={error:s}}finally{try{r&&!r.done&&(o=n.return)&&(yield o.call(n))}finally{if(i)throw i.error}}t.complete()})})(e,t).catch(n=>t.error(n))})}function $(e){return t=>{if(function ne(e){return d(e?.lift)}(t))return t.lift(function(n){try{return e(n,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function E(e,t,n,r,i){return new re(e,t,n,r,i)}class re extends K{constructor(t,n,r,i,o,s){super(t),this.onFinalize=o,this.shouldUnsubscribe=s,this._next=n?function(c){try{n(c)}catch(l){t.error(l)}}:super._next,this._error=i?function(c){try{i(c)}catch(l){t.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=r?function(){try{r()}catch(c){t.error(c)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:n}=this;super.unsubscribe(),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}}}function it(e,t){return $((n,r)=>{let i=0;n.subscribe(E(r,o=>{r.next(e.call(t,o,i++))}))})}function ie(e,t,n,r=0,i=!1){const o=t.schedule(function(){n(),i?e.add(this.schedule(null,r)):this.unsubscribe()},r);if(e.add(o),!i)return o}function ot(e,t,n=1/0){return d(t)?ot((r,i)=>it((o,s)=>t(r,o,i,s))(j(e(r,i))),n):("number"==typeof t&&(n=t),$((r,i)=>function oe(e,t,n,r,i,o,s,c){const l=[];let a=0,u=0,f=!1;const h=()=>{f&&!l.length&&!a&&t.complete()},p=y=>a<r?m(y):l.push(y),m=y=>{o&&t.next(y),a++;let b=!1;j(n(y,u++)).subscribe(E(t,g=>{i?.(g),o?p(g):t.next(g)},()=>{b=!0},void 0,()=>{if(b)try{for(a--;l.length&&a<r;){const g=l.shift();s?ie(t,s,()=>m(g)):m(g)}h()}catch(g){t.error(g)}}))};return e.subscribe(E(t,p,()=>{f=!0,h()})),()=>{c?.()}}(r,i,e,n)))}const{isArray:se}=Array;const le=["addListener","removeListener"],ue=["addEventListener","removeEventListener"],fe=["on","off"];function st(e,t){return n=>r=>e[n](t,r)}const T=1200,H=109,ge=["\u2460","\u2461","\u2462","\u2463","\u2464","\u2465","\u2466","\u2467","\u2468","\u2469","\u246a","\u246b","\u246c","\u246d","\u246e","\u246f","\u2470","\u2471","\u2472","\u2473"];class C{constructor(t,n){this.charHeight=t,this.allQuestionData=n,this.maxHeight=n.questions.length<=10?800:360;const r=new OffscreenCanvas(T,900),i=r.getContext("2d");if(!i)throw new Error("Canvas\u306eContext\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f");this.canvas=r,this.ctx=i,this.fontFamily=C.selectFont();const o={fontSize:27,fontFamily:this.fontFamily};this.setFontData(o),this.defaultFontData=o,i.textAlign="center",i.textBaseline="top"}static selectFont(){let t="";return t=-1!==navigator.userAgent.toLowerCase().indexOf("windows nt")?"\u6e38\u660e\u671d":"serif",t}setFontData(t){this.ctx.font=`${t.fontSize}px "${t.fontFamily}"`}modifyFontSize(t,n=this.maxHeight,r=27){const i={fontSize:r,fontFamily:this.fontFamily};let o=this.charHeight.get(i);for(;t*o>n;)i.fontSize-=1,o=this.charHeight.get(i);return i.fontSize}drawTategakiText(t,n,r,i,o="black"){this.setFontData(i);const s=this.charHeight.get(i);let c=n,l=r;for(const[u,f]of Array.from(t).entries()){let h=f,p=!1;this.ctx.fillStyle=o,"\u30fc"===f&&(h="\u2758"),("\u3001"===f||"\u3002"===f)&&(c+=s/2,l-=s/2,p=!0),this.ctx.fillText(h,c,l+s*u),p&&(c-=s/2,l+=s/2)}return l+s*t.length}}class be extends C{constructor(){super(...arguments),this.drawSingleQuestion=(t,n,r,i,o)=>{const s=this.charHeight.get(o);this.ctx.fillStyle="black",this.ctx.fillText(ge[t],r,i);const c=i+1.5*s;null==n.fullText||null==n.questionType||null==n.targetKanji||null==n.yomigana||("yomi"===n.questionType?this.drawSingleReadingQuestion(n,r,c):this.drawSingleWritingQuestion(n,s,r,c))}}drawReadingQuestionLine(t,n,r,i){const o=t.fullText.indexOf(t.targetKanji);this.ctx.beginPath(),this.ctx.moveTo(r+n/2+5,i+n*o),this.ctx.lineTo(r+n/2+5,i+n*(o+t.targetKanji.length)),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}drawSingleReadingQuestion(t,n,r){const i={fontSize:this.modifyFontSize(t.fullText.length),fontFamily:this.fontFamily};this.setFontData(i),this.drawTategakiText(t.fullText,n,r,i);const o=this.charHeight.get(i);this.drawReadingQuestionLine(t,o,n,r)}drawWrightingQuestionBox(t,n,r,i){this.setFontData(n);const o=this.charHeight.get(n),s=t.targetKanji.length;if(this.ctx.fillStyle="white",this.ctx.strokeStyle="black",this.ctx.lineWidth=1,s>0&&(this.ctx.rect(r-o,i,2*o,o*s*2),this.ctx.fill(),this.ctx.stroke()),s>1)for(let y=0;y<s-1;y++)this.ctx.beginPath(),this.ctx.moveTo(r-o,i+o*(y+1)*2),this.ctx.lineTo(r+o,i+o*(y+1)*2),this.ctx.stroke();const a=i+o*s,u={fontSize:18,fontFamily:this.fontFamily},f=this.charHeight.get(u);return this.drawTategakiText(t.yomigana,r+o+15,a-t.yomigana.length*f/2,u),i+o*s*2}drawSingleWritingQuestion(t,n,r,i){const o={fontSize:this.modifyFontSize(t.fullText.length-t.targetKanji.length,this.maxHeight-n*t.targetKanji.length*2),fontFamily:this.fontFamily};if(t.fullText.includes(t.targetKanji))if(0===t.fullText.indexOf(t.targetKanji)){const c=this.drawWrightingQuestionBox(t,o,r,i);this.drawTategakiText(t.fullText.replace(t.targetKanji,""),r,c,o)}else{const c=t.fullText.split(t.targetKanji);let l=this.drawTategakiText(c[0],r,i,o);l=this.drawWrightingQuestionBox(t,o,r,l),this.drawTategakiText(c[1],r,l,o)}}draw(){for(const[t,n]of this.allQuestionData.questions.entries())this.drawSingleQuestion(t,n,t<10?T-H*(t+1):T-H*(t-10+1),t<10?40:480,this.defaultFontData);return this.allQuestionData.questions.length>10&&(this.ctx.beginPath(),this.ctx.moveTo(50,450),this.ctx.lineTo(1150,450),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()),this.canvas.transferToImageBitmap()}}class we extends C{drawSingleReadingAnswer(t,n,r,i,o){const s={fontSize:this.modifyFontSize(t.fullText.length),fontFamily:this.fontFamily},c=this.charHeight.get(s),l={fontSize:this.modifyFontSize(t.targetKanji.length,o+c*(n+t.targetKanji.length)-(o+c*n),r),fontFamily:this.fontFamily};this.drawTategakiText(t.yomigana,i+c+5,o+c*n,l,"red")}drawSingleWritingAnswer(t,n,r,i,o){if(t.fullText.includes(t.targetKanji)){const s={fontSize:this.modifyFontSize(t.fullText.length-t.targetKanji.length,this.maxHeight-r*t.targetKanji.length*2),fontFamily:this.fontFamily},c=this.charHeight.get(s);this.setFontData(s);for(const[l,a]of Array.from(t.targetKanji).entries()){this.ctx.fillStyle="red";let u=a;"\u30fc"===a&&(u="\u2758"),this.ctx.fillText(u,i,o+2*c*(l+.25)+c*n)}}}drawSingleAnswer(t,n,r,i){this.setFontData(i);const o=this.charHeight.get(i),c=t.fullText.indexOf(t.targetKanji),l=r+1.5*o;null==t.fullText||null==t.questionType||null==t.targetKanji||null==t.yomigana||("yomi"===t.questionType?this.drawSingleReadingAnswer(t,c,18,n,l):this.drawSingleWritingAnswer(t,c,o,n,l))}draw(){for(const[t,n]of this.allQuestionData.questions.entries())this.drawSingleAnswer(n,t<10?T-H*(t+1):T-H*(t-10+1),t<10?40:480,this.defaultFontData);return this.canvas.transferToImageBitmap()}}class _e{constructor(t,n){this.questionCanvas=new be(t,n),this.answerCanvas=new we(t,n)}createImages(){return[this.questionCanvas.draw(),this.answerCanvas.draw()]}}console.debug("Web Worker\u8d77\u52d5");const ve=new class me{constructor(){this.cachedCharHeight={};const t=new OffscreenCanvas(T,900).getContext("2d");if(!t)throw new Error("1\u6587\u5b57\u306e\u9ad8\u3055\u53d6\u5f97\u7528Canvas\u306eContext\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f");this.ctx=t}get(t){const n=`${t.fontSize}_${t.fontFamily}`;if(n in this.cachedCharHeight)return this.cachedCharHeight[n];this.ctx.font=`${t.fontSize}px "${t.fontFamily}"`;const r=this.ctx.measureText("\u3042").width;return this.cachedCharHeight[n]=r,r}};(function B(e,t,n,r){if(d(n)&&(r=n,n=void 0),r)return B(e,t,n).pipe(function ae(e){return it(t=>function ce(e,t){return se(t)?e(...t):e(t)}(e,t))}(r));const[i,o]=function ye(e){return d(e.addEventListener)&&d(e.removeEventListener)}(e)?ue.map(s=>c=>e[s](t,c,n)):function he(e){return d(e.addListener)&&d(e.removeListener)}(e)?le.map(st(e,t)):function de(e){return d(e.on)&&d(e.off)}(e)?fe.map(st(e,t)):[];if(!i&&X(e))return ot(s=>B(s,t,n))(j(e));if(!i)throw new TypeError("Invalid event target");return new S(s=>{const c=(...l)=>s.next(1<l.length?l:l[0]);return i(c),()=>o(c)})})(self,"message").pipe(function pe(e,t){return $((n,r)=>{let i=null,o=0,s=!1;const c=()=>s&&!i&&r.complete();n.subscribe(E(r,l=>{i?.unsubscribe();let a=0;const u=o++;j(e(l,u)).subscribe(i=E(r,f=>r.next(t?t(l,f,u,a++):f),()=>{i=null,c()}))},()=>{s=!0,c()}))})}(e=>new Promise(n=>{console.debug("\u6f22\u5b57\u30c6\u30b9\u30c8\u4f5c\u6210\u306e\u30bf\u30b9\u30af\u3092\u958b\u59cb\u3057\u307e\u3059"),n(new _e(ve,e.data).createImages())}))).subscribe({next:e=>{postMessage(e,[...e]),console.debug("\u6f22\u5b57\u30c6\u30b9\u30c8\u4f5c\u6210\u306e\u30bf\u30b9\u30af\u304c\u5b8c\u4e86\u3057\u307e\u3057\u305f")},error:e=>{console.error(e)}})})();